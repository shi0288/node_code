var CronJob = require("cron").CronJob;
var async = require('async');
var moment = require("moment");
var dc = require('mcp_db').dc;
var prop = require('mcp_config').prop;
var esut = require("easy_util");
var log = esut.log;
var digestUtil = esut.digestUtil;
var termSer = require("mcp_service").termSer;

var cons = require('mcp_constants');
var termStatus = cons.termStatus;
var msgStatus = cons.msgStatus;
var msgType = cons.msgType;

var termHandle = require("./ClientTermHandle.js");
var termFileHandle = require("./ClientTermFileHandle.js");

var ClientHandle = function(){};

/**
 * 从池中获取需要处理的期次消息
 * @param cb
 */
ClientHandle.prototype.getTermMsgFromPool = function(cb)
{
    var msg = dc.mg_msg.getConn().collection("msg");
    msg.findAndModify({status:msgStatus.INIT, type:msgType.TERM}, {},
    {$set:{status:msgStatus.HANDLING}}, [], function(err, data){
        cb(err, data);
    });
}

/**
 * 获取期次生成文件消息
 * @param cb
 */
ClientHandle.prototype.getTermFileMsgFromPool = function(cb)
{
    var msg = dc.mg_msg.getConn().collection("msg");
    msg.findAndModify({status:msgStatus.INIT, type:msgType.TERM_HIT_FILE}, {},
    {$set:{status:msgStatus.HANDLING}}, [], function(err, data){
        cb(err, data);
    });
}

/**
 * 处理消息
 * @param msg
 * @param cb
 */
ClientHandle.prototype.handle = function(msg, cb)
{
    var self = this;
    if(msg.type == msgType.TERM)
    {
        var table = dc.mg_msg.get("detail_term");
        table.findOne({msgId:msg._id}, {}, [], function(err, dTerm){
            //如果对应的消息内容已经丢失，则直接成功
            if(!dTerm)
            {
                cb(null, {});
                return;
            }
            termHandle.handle(msg, dTerm, function(err, data){
                log.info(err);
                log.info(data);
                //如果处理出错，记录出错的进度
                if(err)
                {
                    cb(err, data);
                }
                else
                {
                    cb(err, data);
                }
            });
        });
    }
    else if(msg.type == msgType.TERM_HIT_FILE)  //期次文件消息
    {
        var table = dc.mg_msg.get("detail_term");
        table.findOne({msgId:msg._id}, {}, [], function(err, dTerm){
            //如果对应的消息内容已经丢失，则直接成功
            if(!dTerm)
            {
                cb(null, {});
                return;
            }
            termFileHandle.handle(msg, dTerm, function(err, data){
                log.info(data);
                //如果处理出错，记录出错的进度
                if(err)
                {
                    log.error(err);
                    cb(err, data);
                }
                else
                {
                    cb(err, data);
                }
            });
        });
    }
    else
    {
        cb(null);
    }
}

module.exports = new ClientHandle();


