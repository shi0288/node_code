var esut = require('easy_util');
var digestUtil = esut.digestUtil;
var dc = require('mcp_db').dc;
var config = require('mcp_config');
var ec = config.ec;
var prop = config.prop;
var log = esut.log;
var cons = require('mcp_constants');
var userType = cons.userType;
var errUrl = cons.errUrl;

var DigestService = function(){};

/**
 * 暂时支持3种密钥来源
 * @param fromType
 */
DigestService.prototype.getKey = function(info, cb)
{
    if(info.fromType == prop.digestFromType.NONE)
    {
        cb(null, digestUtil.getEmptyKey());
    }
    else if(info.fromType == prop.digestFromType.DB)
    {
        var adminiTable = dc.main.get("customer");
        adminiTable.findOne({id:info.userId, type:info.userType}, {}, [], function(err, data){
            log.info(data);
            if(err)
            {
                cb(ec.E9999);
            }
            else
            {
                if(data)
                {
                    cb(null, digestUtil.md5(data.password));
                }
                else
                {
                    cb(ec.E0002);
                }
            }
        });
    }
    else if(info.fromType == prop.digestFromType.CACHE)
    {
        var stInfoTable = dc.mg.get("stInfo");
        stInfoTable.findOne({_id:info.userId}, {}, [], function(err, data){
            if(err)
            {
                cb(ec.E9999);
            }
            else
            {
                if(data)
                {
                    var now = new Date();
                    if(now.getTime() - data.lastActiveTime > prop.loginExpiredSeconds*1000)
                    {
                        if(info.userType!=undefined){
                            ec.E9004.url= errUrl.getInfoById(info.userType).url;
                        }
                        cb(ec.E9004);
                    }
                    else
                    {
                        var key = data.st;
                        stInfoTable.update({_id:info.userId}, {$set:{lastActiveTime:new Date().getTime()}}, [], function(err, data){
                            cb(null, key);
                        });
                    }
                }
                else
                {
                    cb(ec.E0002)
                }
            }
        });
    }
    else if(info.fromType == prop.digestFromType.FIX)
    {
        var stInfoTable = dc.mg.get("stInfo");
        stInfoTable.findOne({_id:info.userId}, {}, [], function(err, data){
            if(err)
            {
                cb(ec.E9999);
            }
            else
            {
                if(data && data.fixSt)
                {
                    var key = data.fixSt;
                    cb(null, key);
                }
                else
                {
                    cb(ec.E0002);
                }
            }
        });
    }
    else
    {
        cb(ec.E9002);
    }
};

module.exports = new DigestService();