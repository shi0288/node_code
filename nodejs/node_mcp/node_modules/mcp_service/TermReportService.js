var async = require('async');

var dc = require("mcp_db").dc;

var esut = require('easy_util');
var log = esut.log;

var config = require('mcp_config');
var ec = config.ec;

var cons = require('mcp_constants');
var userType = cons.userType;
var msgStatus = cons.msgStatus;
var msgType = cons.msgType;
var ticketPrintQueenStatus = cons.ticketPrintQueenStatus;
var ticketPrintStatus = cons.ticketPrintStatus;
var ticketStatus = cons.ticketStatus;
var termStatus = cons.termStatus;
var termReportType = cons.termReportType;

var config = require('mcp_config');
var prop = config.prop;

var transaction = require('./Transaction.js');
var moneySer = require('./MoneyService.js');


var TermReportService = function(){};

/**
 * 保存期次报表
 * @param cb
 */
TermReportService.prototype.saveList = function(term, list, cb)
{
    var self = this;
    //如果不存在，需要补0的字段
    var keyList = {'saleCount':0,'saleAmount':0,'hitCount':0, 'hitAmount':0, 'bonus':0, 'bonusBeforeTax':0,
        'notHitCount':0, 'notHitAmount':0, 'failCount':0, 'failAmount':0};
    var rst = [];
    for(var key in list)
    {
        var set = list[key];
        set.gameCode = term.gameCode;
        set.termCode = term.code;
        for(var nKey in keyList)
        {
            if(set[nKey] == undefined)
            {
                set[nKey] = keyList[nKey];
            }
        }
        rst[rst.length] = set;
    }
    var table = dc.main.get("termreport");
    async.eachSeries(rst, function(rpt, callback) {
        table.save(rpt, {}, function(err, data){
            callback(err);
        });
    }, function(err){
        cb(err, rst);
    });
}

/**
 * 处理报表对应的金额
 * @param rpt
 * @param cb
 */
TermReportService.prototype.handleMoney = function(rpt, cb)
{
    var self = this;
    if(rpt.type == termReportType.SALE)
    {
        var orderId = rpt.gameCode + "_" + rpt.termCode + "_" + rpt.customerId;
        async.waterfall([
            //銷售端獲取獎金
            function(cb)
            {
                var amount = rpt.bonus;
                moneySer.handle(rpt.customerId, orderId, "channel", "cash", "in", "prize", amount, {}, function(err, data){
                    cb(err);
                });
            },
            //出票失败退款
            function(cb)
            {
                var amount = rpt.failAmount;
                moneySer.handle(rpt.customerId, orderId, "channel", "cash", "in", "refund", amount, {}, function(err, data){
                    cb(err, null);
                });
            }
        ], function (err, data) {
            cb(err, data);
        });
    }
    else
    {
        var orderId = rpt.gameCode + "_" + rpt.termCode + "_" + rpt.customerId;
        async.waterfall([
            //出票，獲取出票金
            function(cb)
            {
                var amount = rpt.hitAmount + rpt.notHitAmount;
                moneySer.handle(rpt.customerId, orderId, "channel", "cash", "in", "print", amount, {}, function(err, data){
                    cb(err);
                });
            },
            //扣取獎金
            function(cb)
            {
                var amount = rpt.bonus;
                moneySer.handle(rpt.customerId, orderId, "channel", "cash", "out", "payPrize", amount, {negetive:true}, function(err, data){
                    cb(err, data);
                });
            }
        ], function (err, data) {
            cb(err, data);
        });
    }
}

module.exports = new TermReportService();